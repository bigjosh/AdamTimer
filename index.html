<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000000">
<title>Meditation Timer</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  font-weight: 200;
  -webkit-font-smoothing: antialiased;
}

.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px);
  opacity: 0;
  pointer-events: none;
  transition: none;
}

.screen.active {
  opacity: 1;
  pointer-events: auto;
}

.screen.fade-in {
  animation: fadeIn 500ms ease forwards;
}

.screen.fade-out {
  animation: fadeOut 500ms ease forwards;
  pointer-events: none;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

/* Start Screen */
#start-screen {
  background: #000;
  gap: 30px;
}

.settings-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  width: 100%;
  max-width: 280px;
}

.setting {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  width: 100%;
}

.setting label {
  font-size: 14px;
  font-weight: 300;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  opacity: 0.6;
}

.setting input {
  width: 100%;
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: #fff;
  font-family: inherit;
  font-weight: 200;
  font-size: 32px;
  text-align: center;
  padding: 10px;
  outline: none;
  -moz-appearance: textfield;
}

.setting input::-webkit-outer-spin-button,
.setting input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.setting input:focus {
  border-color: rgba(255, 255, 255, 0.5);
}

.preset-buttons {
  display: flex;
  gap: 6px;
  width: 100%;
  margin-top: 4px;
}

.preset-btn {
  font-size: 15px;
  font-weight: 300;
  padding: 12px 0;
  flex: 1;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.25);
  letter-spacing: 0;
  text-transform: none;
  opacity: 0.7;
}

.preset-btn:active {
  opacity: 1;
  border-color: rgba(255, 255, 255, 0.5);
}

button {
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 30px;
  color: #fff;
  font-family: inherit;
  font-weight: 300;
  font-size: 18px;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 14px 48px;
  cursor: pointer;
  transition: border-color 0.2s, opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
}

button:active {
  border-color: rgba(255, 255, 255, 0.6);
}

button:disabled {
  opacity: 0.25;
  cursor: default;
}

#start-btn {
  margin-top: 10px;
}

.volume-control {
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0.6;
}

.volume-icon {
  flex-shrink: 0;
}

#volume {
  -webkit-appearance: none;
  appearance: none;
  width: 120px;
  height: 1px;
  background: rgba(255, 255, 255, 0.4);
  border-radius: 1px;
  outline: none;
}

#volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  border: none;
}

#volume::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  border: none;
}

/* Timer Screen */
#timer-screen {
  background-color: #000;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

#timer-display {
  font-size: 72px;
  font-weight: 200;
  letter-spacing: 2px;
  text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
  font-variant-numeric: tabular-nums;
}

#timer-display.heartbeat {
  animation: heartbeat 1.5s ease-in-out infinite;
}

@keyframes heartbeat {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.timer-buttons {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  margin-top: 40px;
}

.timer-buttons button {
  min-width: 160px;
}

/* Completion Screen */
#complete-screen {
  background: #000;
  gap: 30px;
}

.stats {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  font-size: 18px;
  font-weight: 200;
  opacity: 0.8;
}

.stats .total-time {
  font-size: 48px;
  font-weight: 200;
  opacity: 1;
  margin-bottom: 8px;
}

.log-prompt {
  font-size: 20px;
  font-weight: 300;
  margin-top: 10px;
}

.log-buttons {
  display: flex;
  gap: 20px;
}

.log-buttons button {
  min-width: 100px;
}

/* Hamburger & Close buttons */
.hamburger, .close-btn {
  position: absolute;
  top: env(safe-area-inset-top, 20px);
  right: env(safe-area-inset-right, 20px);
  background: transparent;
  border: none;
  border-radius: 0;
  color: #fff;
  padding: 10px;
  cursor: pointer;
  opacity: 0.6;
  z-index: 10;
  min-width: 44px;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-tap-highlight-color: transparent;
  letter-spacing: 0;
  text-transform: none;
  font-size: 16px;
}

.hamburger:active, .close-btn:active {
  opacity: 1;
}

/* Menu Screen */
#menu-screen {
  background: #000;
}

.menu-items {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 36px;
}

.menu-item {
  font-size: 20px;
  font-weight: 300;
  letter-spacing: 0.5px;
  color: #fff;
  opacity: 0.8;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.menu-item:active {
  opacity: 1;
}

.menu-item.menu-ios {
  font-size: 13px;
  font-weight: 300;
  opacity: 0.4;
  cursor: default;
  text-align: center;
  line-height: 1.6;
}

/* Stats Screen */
#stats-screen {
  background: #000;
  overflow-y: auto;
  justify-content: flex-start;
  padding-top: calc(env(safe-area-inset-top, 20px) + 50px);
  padding-bottom: 40px;
}

.stats-summary {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
  max-width: 320px;
  margin-bottom: 30px;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  width: 100%;
  font-size: 15px;
  font-weight: 200;
}

.stat-label {
  opacity: 0.6;
}

.stat-value {
  font-weight: 300;
  text-align: right;
}

.stats-date-picker {
  width: 100%;
  max-width: 320px;
  margin-bottom: 20px;
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: #fff;
  font-family: inherit;
  font-weight: 200;
  font-size: 16px;
  padding: 10px 14px;
  outline: none;
  color-scheme: dark;
}

.stats-date-picker:focus {
  border-color: rgba(255, 255, 255, 0.5);
}

.session-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
  max-width: 320px;
}

.session-entry {
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding-top: 14px;
}

.session-entry-date {
  font-size: 14px;
  font-weight: 300;
  opacity: 0.9;
  margin-bottom: 4px;
}

.session-entry-details {
  font-size: 13px;
  font-weight: 200;
  opacity: 0.5;
  line-height: 1.5;
}
</style>
</head>
<body>

<!-- Start Screen -->
<div id="start-screen" class="screen active">
  <button class="hamburger" id="hamburger-btn" aria-label="Menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>
  <div class="settings-group">
    <div class="setting">
      <label for="lead-in">Lead In</label>
      <input type="text" id="lead-in" readonly data-value="0" value="0">
      <div class="preset-buttons">
        <button type="button" class="preset-btn" data-add="15">+15m</button>
        <button type="button" class="preset-btn" data-add="5">+5m</button>
        <button type="button" class="preset-btn" data-add="1">+1m</button>
        <button type="button" class="preset-btn" data-add="10s">+10s</button>
        <button type="button" class="preset-btn" data-clear>C</button>
      </div>
    </div>
    <div class="setting">
      <label for="meditation">Meditation</label>
      <input type="text" id="meditation" readonly data-value="20" value="20m">
      <div class="preset-buttons">
        <button type="button" class="preset-btn" data-add="15">+15m</button>
        <button type="button" class="preset-btn" data-add="5">+5m</button>
        <button type="button" class="preset-btn" data-add="1">+1m</button>
        <button type="button" class="preset-btn" data-add="10s">+10s</button>
        <button type="button" class="preset-btn" data-clear>C</button>
      </div>
    </div>
    <div class="setting">
      <label for="lead-out">Come Out</label>
      <input type="text" id="lead-out" readonly data-value="0" value="0">
      <div class="preset-buttons">
        <button type="button" class="preset-btn" data-add="15">+15m</button>
        <button type="button" class="preset-btn" data-add="5">+5m</button>
        <button type="button" class="preset-btn" data-add="1">+1m</button>
        <button type="button" class="preset-btn" data-add="10s">+10s</button>
        <button type="button" class="preset-btn" data-clear>C</button>
      </div>
    </div>
  </div>
  <button id="start-btn" disabled>Start</button>
  <div class="volume-control">
    <svg class="volume-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path id="vol-wave-1" d="M15.54 8.46a5 5 0 010 7.07"/><path id="vol-wave-2" d="M19.07 4.93a10 10 0 010 14.14"/></svg>
    <input type="range" id="volume" min="0" max="100" value="80">
  </div>
</div>

<!-- Timer Screen -->
<div id="timer-screen" class="screen">
  <div id="timer-display">00:00</div>
  <div class="timer-buttons">
    <button id="pause-btn">Pause</button>
    <button id="end-btn">End</button>
  </div>
</div>

<!-- Completion Screen -->
<div id="complete-screen" class="screen">
  <div class="stats">
    <div class="total-time" id="stat-total">00:00</div>
  </div>
  <div class="log-prompt">Log this session?</div>
  <div class="log-buttons">
    <button id="log-yes">Yes</button>
    <button id="log-no">No</button>
  </div>
</div>

<!-- Menu Screen -->
<div id="menu-screen" class="screen">
  <button class="close-btn" id="menu-close" aria-label="Close">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
  </button>
  <div class="menu-items">
    <a class="menu-item" id="menu-statistics">Statistics</a>
    <a class="menu-item" id="menu-update">Update</a>
    <a class="menu-item" id="menu-install" style="display:none">Install App</a>
    <div class="menu-item menu-ios" id="menu-ios" style="display:none">
      Tap <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="vertical-align:middle;margin:0 2px"><path d="M12 3v12M12 3l-4 4M12 3l4 4"/><path d="M4 15v4a1 1 0 001 1h14a1 1 0 001-1v-4"/></svg> then <strong>Add to Home Screen</strong>
    </div>
  </div>
</div>

<!-- Stats Screen -->
<div id="stats-screen" class="screen">
  <button class="close-btn" id="stats-close" aria-label="Close">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
  </button>
  <div class="stats-summary" id="stats-summary"></div>
  <input type="date" class="stats-date-picker" id="stats-date-picker">
  <div class="session-list" id="session-list"></div>
</div>

<audio id="audio-knock" preload="auto" src="knock.mp3"></audio>
<audio id="audio-gong" preload="auto" src="gong.mp3"></audio>

<script src="NoSleep.min.js"></script>
<script>
(function () {
  'use strict';

  // --- Elements ---
  const startScreen = document.getElementById('start-screen');
  const timerScreen = document.getElementById('timer-screen');
  const completeScreen = document.getElementById('complete-screen');
  const menuScreen = document.getElementById('menu-screen');
  const statsScreen = document.getElementById('stats-screen');
  const screens = [startScreen, timerScreen, completeScreen, menuScreen, statsScreen];

  const hamburgerBtn = document.getElementById('hamburger-btn');
  const menuCloseBtn = document.getElementById('menu-close');
  const menuStatistics = document.getElementById('menu-statistics');
  const menuUpdateBtn = document.getElementById('menu-update');
  const menuInstallBtn = document.getElementById('menu-install');
  const menuIosEl = document.getElementById('menu-ios');
  const statsCloseBtn = document.getElementById('stats-close');
  const statsDatePicker = document.getElementById('stats-date-picker');
  const sessionListEl = document.getElementById('session-list');
  const statsSummaryEl = document.getElementById('stats-summary');

  const leadInInput = document.getElementById('lead-in');
  const meditationInput = document.getElementById('meditation');
  const leadOutInput = document.getElementById('lead-out');
  const startBtn = document.getElementById('start-btn');

  const timerDisplay = document.getElementById('timer-display');
  const pauseBtn = document.getElementById('pause-btn');
  const endBtn = document.getElementById('end-btn');

  const statTotal = document.getElementById('stat-total');
  const statLeadIn = document.getElementById('stat-leadin');
  const statMeditation = document.getElementById('stat-meditation');
  const statLeadOut = document.getElementById('stat-leadout');
  const logYes = document.getElementById('log-yes');
  const logNo = document.getElementById('log-no');

  const audioKnock = document.getElementById('audio-knock');
  const audioGong = document.getElementById('audio-gong');

  let noSleep;
  try { noSleep = new NoSleep(); } catch (e) { /* ignore */ }

  // --- State ---
  const phases = ['LEADIN', 'MEDITATION', 'LEADOUT'];
  let currentPhase = null;
  let phaseIndex = 0;
  let phaseDurations = {}; // seconds per phase
  let endTime = 0;       // wall-clock ms target
  let paused = false;
  let pausedRemaining = 0; // ms remaining when paused
  let timerRAF = null;
  let sessionData = {};

  // --- Helpers ---
  function fmt(totalSeconds, forceHours) {
    totalSeconds = Math.round(totalSeconds);
    if (forceHours || totalSeconds >= 3600) {
      var h = Math.floor(totalSeconds / 3600);
      var m = Math.floor((totalSeconds % 3600) / 60);
      var s = totalSeconds % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }
    var m = Math.floor(totalSeconds / 60);
    var s = totalSeconds % 60;
    return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  function formatTimeDisplay(minutes) {
    if (minutes === 0) return '0';
    var totalSec = Math.round(minutes * 60);
    var h = Math.floor(totalSec / 3600);
    var m = Math.floor((totalSec % 3600) / 60);
    var s = totalSec % 60;
    var parts = [];
    if (h > 0) parts.push(h + 'h');
    if (m > 0) parts.push(m + 'm');
    if (s > 0) parts.push(s + 's');
    return parts.join(' ');
  }

  function clampInput(el) {
    let v = parseFloat(el.dataset.value);
    if (isNaN(v) || v < 0) v = 0;
    if (v > 999) v = 999;
    v = Math.round(v * 6) / 6; // round to nearest 10s
    el.dataset.value = v;
    el.value = formatTimeDisplay(v);
    return v;
  }

  // --- localStorage persistence ---
  function loadSettings() {
    try {
      const s = localStorage.getItem('meditation-settings');
      if (s) {
        const d = JSON.parse(s);
        if (d.leadIn != null) leadInInput.dataset.value = d.leadIn;
        if (d.meditation != null) meditationInput.dataset.value = d.meditation;
        if (d.leadOut != null) leadOutInput.dataset.value = d.leadOut;
      }
    } catch (e) { /* private browsing */ }
  }

  function saveSettings() {
    try {
      localStorage.setItem('meditation-settings', JSON.stringify({
        leadIn: clampInput(leadInInput),
        meditation: clampInput(meditationInput),
        leadOut: clampInput(leadOutInput)
      }));
    } catch (e) { /* private browsing */ }
  }

  function loadHistory() {
    try {
      const h = localStorage.getItem('meditation-history');
      return h ? JSON.parse(h) : [];
    } catch (e) { return []; }
  }

  function saveSession(data) {
    try {
      const history = loadHistory();
      history.push(data);
      localStorage.setItem('meditation-history', JSON.stringify(history));
    } catch (e) { /* ignore */ }
  }

  // --- Statistics ---
  function toLocalDateStr(d) {
    return d.getFullYear() + '-' +
      String(d.getMonth() + 1).padStart(2, '0') + '-' +
      String(d.getDate()).padStart(2, '0');
  }

  function formatDuration(minutes) {
    var h = Math.floor(minutes / 60);
    var m = minutes % 60;
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }

  function formatDateNice(dateStr) {
    var d = new Date(dateStr + 'T12:00:00');
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
  }

  function computeStats(history) {
    var totalSessions = history.length;

    var totalMeditationMin = 0;
    history.forEach(function (s) {
      totalMeditationMin += (s.meditation || 0);
    });

    var now = new Date();
    var cutoff = new Date(now);
    cutoff.setDate(cutoff.getDate() - 14);
    var recentMeditationMin = 0;
    history.forEach(function (s) {
      if (new Date(s.date) >= cutoff) {
        recentMeditationMin += (s.meditation || 0);
      }
    });

    var uniqueDates = [];
    var seen = {};
    history.forEach(function (s) {
      var ds = toLocalDateStr(new Date(s.date));
      if (!seen[ds]) { seen[ds] = true; uniqueDates.push(ds); }
    });
    uniqueDates.sort();

    // Current streak: walk backwards from today
    var currentStreak = 0;
    var check = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    while (true) {
      var cs = toLocalDateStr(check);
      if (seen[cs]) {
        currentStreak++;
        check.setDate(check.getDate() - 1);
      } else {
        break;
      }
    }

    // Longest streak
    var longestStreak = 0;
    var longestEnd = '';
    if (uniqueDates.length > 0) {
      var streak = 1;
      var streakEnd = uniqueDates[0];
      for (var i = 1; i < uniqueDates.length; i++) {
        var prev = new Date(uniqueDates[i - 1] + 'T12:00:00');
        var curr = new Date(uniqueDates[i] + 'T12:00:00');
        var diffDays = Math.round((curr - prev) / (1000 * 60 * 60 * 24));
        if (diffDays === 1) {
          streak++;
          streakEnd = uniqueDates[i];
        } else {
          if (streak > longestStreak) {
            longestStreak = streak;
            longestEnd = streakEnd;
          }
          streak = 1;
          streakEnd = uniqueDates[i];
        }
      }
      if (streak > longestStreak) {
        longestStreak = streak;
        longestEnd = streakEnd;
      }
    }

    return {
      totalSessions: totalSessions,
      totalMeditationMin: totalMeditationMin,
      recentMeditationMin: recentMeditationMin,
      currentStreak: currentStreak,
      longestStreak: longestStreak,
      longestEnd: longestEnd
    };
  }

  function renderStatsSummary(stats) {
    var html = '';
    html += '<div class="stat-row"><span class="stat-label">Total Sessions</span><span class="stat-value">' + stats.totalSessions + '</span></div>';
    html += '<div class="stat-row"><span class="stat-label">Total Meditation</span><span class="stat-value">' + formatDuration(stats.totalMeditationMin) + '</span></div>';
    html += '<div class="stat-row"><span class="stat-label">Last 14 Days</span><span class="stat-value">' + formatDuration(stats.recentMeditationMin) + '</span></div>';
    html += '<div class="stat-row"><span class="stat-label">Current Streak</span><span class="stat-value">' + stats.currentStreak + (stats.currentStreak === 1 ? ' day' : ' days') + '</span></div>';
    var longestText = stats.longestStreak + (stats.longestStreak === 1 ? ' day' : ' days');
    if (stats.longestEnd) longestText += ' (' + formatDateNice(stats.longestEnd) + ')';
    html += '<div class="stat-row"><span class="stat-label">Longest Streak</span><span class="stat-value">' + longestText + '</span></div>';
    statsSummaryEl.innerHTML = html;
  }

  function renderSessionList(history) {
    var sorted = history.slice().sort(function (a, b) { return new Date(b.date) - new Date(a.date); });
    var html = '';
    sorted.forEach(function (s) {
      var d = new Date(s.date);
      var dateStr = toLocalDateStr(d);
      var timeStr = d.toLocaleString(undefined, {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit'
      });
      var medMin = s.meditation || 0;
      var totalMin = s.totalMinutes || 0;
      var status = s.completedFull ? 'Completed' : 'Ended early';

      html += '<div class="session-entry" data-date="' + dateStr + '">';
      html += '<div class="session-entry-date">' + timeStr + '</div>';
      html += '<div class="session-entry-details">';
      html += 'Meditation: ' + medMin + ' min &middot; Total: ' + totalMin + ' min &middot; ' + status;
      html += '</div></div>';
    });

    if (sorted.length === 0) {
      html = '<div class="session-entry-details" style="text-align:center;opacity:0.4">No sessions logged yet</div>';
    }

    sessionListEl.innerHTML = html;
  }

  // --- Validation ---
  function validateInputs() {
    const li = clampInput(leadInInput);
    const med = clampInput(meditationInput);
    const lo = clampInput(leadOutInput);
    const total = li + med + lo;
    startBtn.disabled = total === 0;
  }

  // --- Screen transitions ---
  var FADE_MS = 500;

  function showScreen(target) {
    return new Promise(resolve => {
      const current = screens.find(s => s.classList.contains('active'));

      if (current && current !== target) {
        current.classList.add('fade-out');
        current.classList.remove('fade-in');
        setTimeout(() => {
          current.classList.remove('active', 'fade-out');
          current.style.opacity = '';
          target.classList.add('active', 'fade-in');
          setTimeout(() => {
            target.classList.remove('fade-in');
            resolve();
          }, FADE_MS);
        }, FADE_MS);
      } else {
        target.classList.add('active', 'fade-in');
        setTimeout(() => {
          target.classList.remove('fade-in');
          resolve();
        }, FADE_MS);
      }
    });
  }

  // --- Volume ---
  const volumeSlider = document.getElementById('volume');
  const volWave1 = document.getElementById('vol-wave-1');
  const volWave2 = document.getElementById('vol-wave-2');

  function applyVolume(v) {
    var vol = v / 100;
    audioKnock.volume = vol;
    audioGong.volume = vol;
    // Update icon waves visibility
    volWave1.style.opacity = v > 0 ? 1 : 0;
    volWave2.style.opacity = v > 40 ? 1 : 0;
  }

  function loadVolume() {
    try {
      var v = localStorage.getItem('meditation-volume');
      if (v !== null) { volumeSlider.value = v; }
    } catch (e) {}
    applyVolume(Number(volumeSlider.value));
  }

  volumeSlider.addEventListener('input', function () {
    var v = Number(volumeSlider.value);
    applyVolume(v);
    try { localStorage.setItem('meditation-volume', v); } catch (e) {}
  });

  // --- Audio ---
  function primeAudio() {
    [audioKnock, audioGong].forEach(a => {
      var savedVol = a.volume;
      a.volume = 0;
      a.play().then(() => { a.pause(); a.currentTime = 0; a.volume = savedVol; }).catch(() => { a.volume = savedVol; });
    });
  }

  function playSound(audioEl) {
    audioEl.currentTime = 0;
    audioEl.play().catch(() => {});
  }

  // --- Timer ---
  function startPhaseTimer(durationSec) {
    paused = false;
    pauseBtn.textContent = 'Pause';
    timerDisplay.classList.remove('heartbeat');
    endTime = Date.now() + durationSec * 1000;
    tick();
  }

  function tick() {
    if (paused) return;

    const now = Date.now();
    const remaining = Math.max(0, endTime - now);
    const secs = Math.ceil(remaining / 1000);

    var useHours = phaseDurations[currentPhase] >= 3600;
    if (currentPhase === 'LEADOUT') {
      timerDisplay.textContent = fmt(phaseDurations[currentPhase] - secs, useHours);
    } else {
      timerDisplay.textContent = fmt(secs, useHours);
    }

    if (remaining <= 0) {
      timerDisplay.textContent = currentPhase === 'LEADOUT' ? fmt(phaseDurations[currentPhase], useHours) : fmt(0, useHours);
      onPhaseComplete();
      return;
    }

    timerRAF = requestAnimationFrame(tick);
  }

  function onPhaseComplete() {
    cancelAnimationFrame(timerRAF);

    // Play sound for completed phase
    if (currentPhase === 'LEADIN') {
      playSound(audioKnock);
    } else if (currentPhase === 'MEDITATION') {
      playSound(audioGong);
    } else if (currentPhase === 'LEADOUT') {
      playSound(audioKnock);
    }

    // Brief pause for sound, then advance
    setTimeout(() => advancePhase(), 400);
  }

  function advancePhase() {
    phaseIndex++;

    // Find next non-zero phase
    while (phaseIndex < phases.length && phaseDurations[phases[phaseIndex]] === 0) {
      phaseIndex++;
    }

    if (phaseIndex >= phases.length) {
      // All phases done
      finishSession(false);
      return;
    }

    currentPhase = phases[phaseIndex];
    transitionTimerPhase();
  }

  function transitionTimerPhase() {
    // Fade out current background
    timerScreen.classList.add('fade-out');
    timerScreen.classList.remove('fade-in');

    setTimeout(() => {
      // Set new time and background while invisible
      setTimerBackground(currentPhase);
      timerDisplay.textContent = currentPhase === 'LEADOUT' ? fmt(0, phaseDurations[currentPhase] >= 3600) : fmt(phaseDurations[currentPhase]);

      timerScreen.classList.remove('fade-out');
      timerScreen.classList.add('fade-in');

      setTimeout(() => {
        timerScreen.classList.remove('fade-in');
      }, FADE_MS);

      startPhaseTimer(phaseDurations[currentPhase]);
    }, FADE_MS);
  }

  function setTimerBackground(phase) {
    if (phase === 'LEADIN') {
      timerScreen.style.backgroundImage = 'none';
      timerScreen.style.backgroundColor = '#111';
    } else if (phase === 'MEDITATION') {
      timerScreen.style.backgroundImage = 'url(sand.jpg)';
      timerScreen.style.backgroundColor = '#000';
    } else {
      timerScreen.style.backgroundImage = 'url(sea.jpg)';
      timerScreen.style.backgroundColor = '#000';
    }
  }

  // --- Session flow ---
  function startSession() {
    startBtn.disabled = true;

    const li = clampInput(leadInInput);
    let med = clampInput(meditationInput);
    const lo = clampInput(leadOutInput);

    // Default meditation to 20 if all zeros handled by validation,
    // but if meditation specifically is 0/NaN and others exist, keep it 0
    if (li + med + lo === 0) return;

    phaseDurations = {
      LEADIN: li * 60,
      MEDITATION: med * 60,
      LEADOUT: lo * 60
    };

    sessionData = {
      date: new Date().toISOString(),
      leadIn: li,
      meditation: med,
      leadOut: lo,
      totalMinutes: li + med + lo,
      completedFull: false
    };

    // Prime audio on user gesture
    primeAudio();

    // Wake lock enabled in click handler above

    // Find first non-zero phase
    phaseIndex = 0;
    while (phaseIndex < phases.length && phaseDurations[phases[phaseIndex]] === 0) {
      phaseIndex++;
    }

    if (phaseIndex >= phases.length) return; // shouldn't happen due to validation

    currentPhase = phases[phaseIndex];
    setTimerBackground(currentPhase);
    timerDisplay.textContent = currentPhase === 'LEADOUT' ? fmt(0, phaseDurations[currentPhase] >= 3600) : fmt(phaseDurations[currentPhase]);

    showScreen(timerScreen).then(() => {
      startPhaseTimer(phaseDurations[currentPhase]);
    });
  }

  function finishSession(early) {
    cancelAnimationFrame(timerRAF);
    paused = false;
    timerDisplay.classList.remove('heartbeat');

    try { noSleep && noSleep.disable(); } catch (e) { /* ignore */ }

    sessionData.completedFull = !early;

    // Build stats
    statTotal.textContent = fmt(sessionData.meditation * 60);

    showScreen(completeScreen);
  }

  // --- Pause ---
  function togglePause() {
    if (paused) {
      // Resume
      paused = false;
      endTime = Date.now() + pausedRemaining;
      pauseBtn.textContent = 'Pause';
      timerDisplay.classList.remove('heartbeat');
      tick();
    } else {
      // Pause
      paused = true;
      cancelAnimationFrame(timerRAF);
      pausedRemaining = Math.max(0, endTime - Date.now());
      pauseBtn.textContent = 'Resume';
      timerDisplay.classList.add('heartbeat');
    }
  }

  // --- Preset buttons ---
  document.querySelectorAll('.preset-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var input = btn.closest('.setting').querySelector('input');
      if (btn.dataset.clear !== undefined) {
        input.dataset.value = 0;
      } else {
        var addVal = btn.dataset.add;
        var addMin = addVal.endsWith('s') ? parseFloat(addVal) / 60 : parseFloat(addVal);
        input.dataset.value = parseFloat(input.dataset.value || 0) + addMin;
      }
      clampInput(input);
      validateInputs();
      saveSettings();
    });
  });

  // --- Event listeners ---
  [leadInInput, meditationInput, leadOutInput].forEach(input => {
    input.addEventListener('input', () => {
      validateInputs();
      saveSettings();
    });
    input.addEventListener('blur', () => {
      clampInput(input);
      validateInputs();
      saveSettings();
    });
  });

  startBtn.addEventListener('click', () => {
    if (startBtn.disabled) return;
    // Enable wake lock immediately on user gesture (iOS requires this)
    try { noSleep && noSleep.enable(); } catch (e) { /* ignore */ }
    startSession();
  });

  pauseBtn.addEventListener('click', togglePause);

  endBtn.addEventListener('click', () => {
    finishSession(true);
  });

  logYes.addEventListener('click', () => {
    saveSession(sessionData);
    showScreen(startScreen).then(() => {
      startBtn.disabled = false;
      validateInputs();
    });
  });

  logNo.addEventListener('click', () => {
    showScreen(startScreen).then(() => {
      startBtn.disabled = false;
      validateInputs();
    });
  });

  // --- Menu navigation ---
  hamburgerBtn.addEventListener('click', () => {
    showScreen(menuScreen);
  });

  menuCloseBtn.addEventListener('click', () => {
    showScreen(startScreen);
  });

  statsCloseBtn.addEventListener('click', () => {
    showScreen(startScreen);
  });

  menuStatistics.addEventListener('click', () => {
    var history = loadHistory();
    var stats = computeStats(history);
    renderStatsSummary(stats);
    renderSessionList(history);
    statsDatePicker.value = '';
    showScreen(statsScreen);
  });

  statsDatePicker.addEventListener('change', () => {
    var target = statsDatePicker.value;
    if (!target) return;
    var entries = sessionListEl.querySelectorAll('.session-entry');
    for (var i = 0; i < entries.length; i++) {
      if (entries[i].dataset.date === target) {
        entries[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
        break;
      }
    }
  });

  // --- Force update ---
  menuUpdateBtn.addEventListener('click', async () => {
    menuUpdateBtn.textContent = 'Updating\u2026';
    menuUpdateBtn.style.opacity = '0.4';
    menuUpdateBtn.style.pointerEvents = 'none';
    try {
      var keys = await caches.keys();
      await Promise.all(keys.map(function (k) { return caches.delete(k); }));
    } catch (e) {}
    try {
      var regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(function (r) { return r.unregister(); }));
    } catch (e) {}
    location.reload();
  });

  // --- Install prompt ---
  let deferredInstallPrompt = null;

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredInstallPrompt = e;
    menuInstallBtn.style.display = '';
  });

  menuInstallBtn.addEventListener('click', () => {
    if (!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(result => {
      deferredInstallPrompt = null;
      if (result.outcome === 'accepted') {
        menuInstallBtn.style.display = 'none';
      }
    });
  });

  window.addEventListener('appinstalled', () => {
    menuInstallBtn.style.display = 'none';
    deferredInstallPrompt = null;
  });

  // iOS detection â€” no install prompt API, show manual instructions
  (function () {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.navigator.standalone === true;
    if (isIOS && !isStandalone) {
      menuIosEl.style.display = '';
    }
  })();

  // --- Init ---
  loadSettings();
  loadVolume();
  validateInputs();

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' })
      .then(function (reg) { reg.update(); })
      .catch(function () {});
  }
})();
</script>
</body>
</html>
